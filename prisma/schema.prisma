// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  gatingRuns          GatingRun[]
  scorecardRuns       ScorecardRun[]
  financialEntries    FinancialEntry[]
  financialSettings   ProjectFinancialSettings?

  @@map("projects")
}

model GateQuestion {
  id        String   @id @default(cuid())
  text      String
  order     Int      @unique
  createdAt DateTime @default(now())

  answers GatingAnswer[]

  @@map("gate_questions")
}

model GatingRun {
  id        String   @id @default(cuid())
  projectId String
  createdAt DateTime @default(now())

  project Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  answers GatingAnswer[]

  @@map("gating_runs")
}

model GatingAnswer {
  id         String   @id @default(cuid())
  runId      String
  questionId String
  value      Boolean
  createdAt  DateTime @default(now())

  run      GatingRun    @relation(fields: [runId], references: [id], onDelete: Cascade)
  question GateQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([runId, questionId])
  @@map("gating_answers")
}

model ScorecardQuestion {
  id         String   @id @default(cuid())
  text       String
  stepNumber Int
  order      Int
  weight     Float    @default(1.0)
  criteria   Json     @default("[]")
  createdAt  DateTime @default(now())

  scores ScorecardScore[]

  @@unique([stepNumber, order])
  @@map("scorecard_questions")
}

model ScorecardRun {
  id        String   @id @default(cuid())
  projectId String
  name      String?
  createdAt DateTime @default(now())

  project        Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scores         ScorecardScore[]
  financialCosts FinancialCost[]
  overview       ScorecardOverview?
  stepComments   ScorecardStepComment[]

  @@map("scorecard_runs")
}

model ScorecardScore {
  id         String   @id @default(cuid())
  runId      String
  questionId String
  value      Int      // 0-5 scale
  createdAt  DateTime @default(now())

  run      ScorecardRun      @relation(fields: [runId], references: [id], onDelete: Cascade)
  question ScorecardQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([runId, questionId])
  @@map("scorecard_scores")
}

model ScorecardOverview {
  id        String   @id @default(cuid())
  runId     String   @unique
  pros      String?  // Optional pros summary
  cons      String?  // Optional cons summary
  summary   String?  // Optional overall summary
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run ScorecardRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("scorecard_overviews")
}

model ScorecardStepComment {
  id         String   @id @default(cuid())
  runId      String
  stepNumber Int      // Which step this comment is for
  comment    String   // The step-level comment
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  run ScorecardRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, stepNumber])
  @@map("scorecard_step_comments")
}

enum Currency {
  GBP
  USD
  EUR
}

enum CostCategory {
  IMPLEMENTATION_CAPEX
  IMPLEMENTATION_OPEX
  ONGOING_CAPEX
  ONGOING_OPEX
}

model ProjectFinancialSettings {
  id        String   @id @default(cuid())
  projectId String   @unique
  currency  Currency @default(GBP)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_financial_settings")
}

model FinancialEntry {
  id        String       @id @default(cuid())
  projectId String
  name      String
  category  CostCategory
  order     Int
  createdAt DateTime     @default(now())

  project Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  costs   FinancialCost[]

  @@map("financial_entries")
}

model FinancialCost {
  id             String   @id @default(cuid())
  entryId        String
  scorecardRunId String
  amount         Decimal  @db.Decimal(15, 2)
  createdAt      DateTime @default(now())

  entry        FinancialEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  scorecardRun ScorecardRun   @relation(fields: [scorecardRunId], references: [id], onDelete: Cascade)

  @@unique([entryId, scorecardRunId])
  @@map("financial_costs")
}
